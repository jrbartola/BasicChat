<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="" />
    <meta name="author" content="" />
    <!--[if IE]>
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <![endif]-->
    <title>Basic Chat</title>
    <!-- BOOTSTRAP CORE STYLE CSS -->
    <link href="/css/bootstrap.css" rel="stylesheet" />
    <!-- FONT AWESOME  CSS -->
    <link href="/css/font-awesome.css" rel="stylesheet" />
    <!-- CUSTOM STYLE CSS -->
    <link href="/css/style.css" rel="stylesheet" />
</head>
<script src="/socket.io/socket.io.js"></script>
<script src="/js/jquery-1.11.1.js"></script>
<script src="//www.parsecdn.com/js/parse-1.6.7.min.js"></script>
    <!-- CORE BOOTSTRAP SCRIPTS  FILE -->
<script src="/js/bootstrap.js"></script>
<script src="/js/tabs.js" type="text/javascript"></script>
<script>
Parse.initialize("EofbpfgreHsypOKPaXjafIuZMsYZ0hPZnSoYLnI9", "by6N3GBA6rlvjtiO2SFo2VlF4EafkNxOXYERhK1m");
var currentUser = Parse.User.current();
if (currentUser == undefined) {
    window.location.href = "/";
}

function showChat(username) {
    $("#none").remove();
    $($("ul#tabs").children()[0]).remove();
    $("#tabs").append("<li><a href='#" + username + "'>" +
                    "<div class='panel-body' name='" + username + "'>" +
                        "<div class='row'>" +
                            "<div class='pull-left col-md-4'>" +
                            "<img class='media-object' data-src='/img/user.gif' alt='user' style={chatmsgstyle} src='/img/user.gif' />" +
                            "</div>" +
                            "<div class='media-body col-md-8'>" +
                            "<h6 class='media-heading'>" + username + "</h6>" +
                            "</div></div></div></a></div></li>");

    $("#messages").append("<div class='tabContent' id='" + username + "'>" +
                    "<div class='msg-wrap' name='mainthing." + username + "'><!-- MESSAGES HERE --></div></div>");



    init();

}

$(document).ready(function() {
    var chatsocket = io();
    init();
    chatsocket.emit('loadUser', currentUser.attributes.username);

    $("#logOut").on("click", function() {
        // log out user and save field as such
        Parse.User.current().set("loggedIn", false);
        Parse.User.current().save(null, {
            success: function(user) {
                console.log("Logged out");
                Parse.User.logOut();
                window.location.href = "/";
            }
        });
        
    });

  $('form#send').on("submit", function(){
    if ($("#none").length == 0) {
        chatsocket.emit('new message', {"message": $('#msg').val(), 
                                    "username" : currentUser.attributes.username,
                                    "to": 'h7m'});
        $('#msg').val('');
    } else if ($("#errors").length == 0) {
        $($(".container-fluid")[1]).prepend("<div id='errors' role='alert' class='alert alert-warning alert-dismissible'><button type='button' class='close' data-dismiss='alert' aria-label='Close'><span aria-hidden='true'>&times;</span></button><strong>Error </strong> You must specify a user first!</div>");
        setTimeout(function() {
            $("#errors").fadeOut("slow", function() {
                $("#errors").remove();
            });
            
        }, 5000);
    }
    
    return false;
  });

  

  chatsocket.on("newUser", function(onliners) {
    
    $("#online").empty();
    
    for (u in onliners) {
        
        
        if ($("#" + onliners[u]).length == 0 && onliners[u] != currentUser.attributes.username) {
            //console.log("Number is " + onliners[u] + " chests");
            //$("#online").append("<div className='tabContent' id='" + onliners[u] + "'>" + 
                //"<div class='msg-wrap' name='mainthing' id ='inner." + onliners[u] + "'></div></div>");

                    $("#online").append($("<div class='chat-box-online-right' onclick='showChat(\"" + onliners[u] + "\");' id='online." + onliners[u] + "'><br /></div>").text(onliners[u]).append($("<hr class='hr-clas-low' />")));
        }

    }
    
  });
  
  chatsocket.on("chat new", function(msg) {
    if (msg.username != currentUser.attributes.username) {
        $("#messages").append($("<div class='chat-box-left'></div><br />").text(msg.message));
    } else {
        $("#messages").append($("<div class='chat-box-right'></div><br />").text(msg.message));
    }
    
  });
  chatsocket.on("disconnect", function(userId) {
    $("#"+userId).remove();
  });

  chatsocket.on("userLeft", function(userId) {

  });

});
  
</script>
<body>
<nav class="navbar navbar-inverse">
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">Home</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">
        <li class="active"><a href="/chat">Chat<span class="sr-only">(current)</span></a></li>
        <li><a href="#">Profile</a></li>
      </ul>
      <form class="navbar-form navbar-left" role="search">
        <div class="form-group">
          <input type="text" class="form-control" placeholder="Search">
        </div>
        <button type="submit" class="btn btn-default">Find</button>
      </form>
      <ul class="nav navbar-nav navbar-right">
        <li><a id="logOut">Log Out</a></li>
      </ul>
    </div><!-- /.navbar-collapse -->
  </div><!-- /.container-fluid -->
</nav>

    <div class="container-fluid">
        <div class="row pad-top pad-bottom">

            <div class="col-lg-3 col-md-3 col-sm-3">
                <div class="conversation-div">
                    <div class="conversation-head">
                        CONVERSATIONS
                    </div>
                    <div class="conversation">
                    <ul id="tabs" style="list-style:none;padding:0;">
                        
                        
                    </ul>
                    </div>

                </div>

            </div>
            <div class=" col-lg-6 col-md-6 col-sm-6">
                <div class="chat-box-div">
                    <div class="chat-box-head">
                        MESSAGES
                            <div class="btn-group pull-right">
                                <button type="button" class="btn btn-info dropdown-toggle" data-toggle="dropdown" aria-expanded="false">
                                    <span class="fa fa-cogs"></span>
                                    <span class="sr-only">Toggle Dropdown</span>
                                </button>
                                <ul class="dropdown-menu" role="menu">
                                    <li><a href="#"><span class="fa fa-map-marker"></span>&nbsp;Invisible</a></li>
                                    <li><a href="#"><span class="fa fa-comments-o"></span>&nbsp;Online</a></li>
                                    <li><a href="#"><span class="fa fa-lock"></span>&nbsp;Busy</a></li>
                                    <li class="divider"></li>
                                    <li><a href="#"><span class="fa fa-circle-o-notch"></span>&nbsp;Logout</a></li>
                                </ul>
                            </div>
                    </div>
                    <div class="panel-body chat-box-main" id="messages">
                    <div class="tabContent" id="none">
                        <div class="msg-wrap" name="mainthing">

                        </div>
                    </div>
                        
                    </div>
                </div>
                <div class="chat-box-footer">
                    <form id="send" action="">
                        <div class="input-group">
                            <input type="text" id="msg" class="form-control" placeholder="Type a message...">
                            <span class="input-group-btn">
                                <button class="btn btn-info" type="submit">SEND</button>
                            </span>
                        </div>
                    </form>
                </div>
                        <!--Messages Go HERE -->
            </div>
                    
            <div class="col-lg-3 col-md-3 col-sm-3">
                <div class="chat-box-online-div">
                    <div class="chat-box-online-head">
                        ONLINE USERS
                    </div>
                    <div class="panel-body chat-box-online" id="online">

                        
                    </div>

                </div>

            </div>
        </div>
    </div>

    <!-- USING SCRIPTS BELOW TO REDUCE THE LOAD TIME -->
    <!-- CORE JQUERY SCRIPTS FILE -->
    
</body>

</html>
